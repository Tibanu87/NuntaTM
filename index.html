<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poze de la NuntÄƒ</title>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
  <style>
    /* stilurile tale existente ... */
    .gallery-btn {
      background: linear-gradient(45deg, #2196f3, #1976d2);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
    }
    .photo-list {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
    }
    .photo-list li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’• Poze NuntÄƒ Maria si Tiberiu ğŸ’•</h1>
      <p>ÃmpÄƒrtÄƒÈ™eÈ™te momentele frumoase cu noi adÄƒugÃ¢nd poze cu voi!ğŸ’•â¤ï¸</p>
    </div>
    
    <div class="content">
      <div id="welcomeForm" class="welcome-form">
        <h3>BunÄƒ ziua! VÄƒ rugÄƒm sÄƒ vÄƒ introduceÈ›i numele:</h3>
        <div class="form-group">
          <label for="guestName">Numele dumneavoastrÄƒ:</label>
          <input type="text" id="guestName" placeholder="ex: Ana È™i Mihai Popescu">
        </div>
        <button class="btn" onclick="setGuestName()">ConfirmÄƒ</button>
      </div>

      <div id="mainApp" class="hidden">
        <div id="welcomeMessage" class="welcome-message"></div>

        <div class="photo-upload">
          <h3>ğŸ“¸ AdaugÄƒ o pozÄƒ nouÄƒ</h3>
          <div class="form-group">
            <label for="photoInput">SelecteazÄƒ poza:</label>
            <input type="file" id="photoInput" accept="image/*" multiple>
          </div>
          <button class="btn" onclick="uploadPhotos()">ÃncarcÄƒ Pozele</button>
        </div>

        <!-- Buton Galerie -->
        <button class="gallery-btn" onclick="loadGalleryFromAppwrite()">ğŸ“‚ Galerie completÄƒ</button>

        <!-- Galeria cu poze -->
        <div class="gallery-section">
          <h3 style="color: #8b7355; margin-bottom: 20px;">ğŸ“· Galeria Foto</h3>
          <div id="photoGallery" class="gallery"></div>
        </div>

        <!-- Lista de poze sub formÄƒ de link -->
        <div class="photo-list">
          <h4>ğŸ“‘ Lista fiÈ™ierelor:</h4>
          <ul id="photoList"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===============================
    // CONFIGURARE APPWRITE
    // ===============================
    const client = new Appwrite.Client()
      .setEndpoint('https://cloud.appwrite.io/v1')
      .setProject('68b1d9c5002d64986cc4'); // Project ID

    const storage = new Appwrite.Storage(client);
    const bucketId = '68b1da9b002d5fd5fe09'; // Bucket ID

    // ===============================
    // VARIABILE LOCALE
    // ===============================
    let currentGuest = '';
    let photos = [];

    // ===============================
    // LOGICA APLICAÈšIEI
    // ===============================
    function setGuestName() {
      const nameInput = document.getElementById('guestName');
      const name = nameInput.value.trim();
      if (name === '') {
        alert('VÄƒ rugÄƒm sÄƒ introduceÈ›i numele!');
        return;
      }
      currentGuest = name;
      document.getElementById('welcomeForm').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('welcomeMessage').innerHTML =
        `<strong>Bun venit, ${currentGuest}!</strong> Acum puteÈ›i adÄƒuga poze È™i vedea pozele celorlalÈ›i invitaÈ›i.`;
    }

    async function uploadPhotos() {
      const photoInput = document.getElementById('photoInput');
      const files = photoInput.files;
      if (files.length === 0) {
        alert('SelecteazÄƒ cel puÈ›in o pozÄƒ!');
        return;
      }

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        try {
          const response = await storage.createFile(
            bucketId,
            Appwrite.ID.unique(),
            file
          );

          const fileUrl =
            client.config.endpoint +
            '/storage/buckets/' + bucketId +
            '/files/' + response.$id +
            '/view?project=' + client.config.project;

          photos.unshift({
            id: response.$id,
            src: fileUrl,
            guestName: currentGuest,
            uploadTime: new Date().toLocaleString('ro-RO'),
            originalName: file.name
          });

          // AdaugÄƒ link Ã®n listÄƒ
          const listItem = document.createElement('li');
          listItem.innerHTML = `<a href="${fileUrl}" target="_blank">${currentGuest} â€“ ${file.name}</a>`;
          document.getElementById('photoList').prepend(listItem);

        } catch (error) {
          console.error("Eroare upload:", error);
          alert("Eroare la Ã®ncÄƒrcarea fiÈ™ierului: " + file.name);
        }
      }

      displayPhotos();
      alert("Upload reuÈ™it!"); // mesajul cerut
      photoInput.value = '';
    }

    function displayPhotos() {
      const gallery = document.getElementById('photoGallery');
      if (photos.length === 0) {
        gallery.innerHTML =
          '<p style="text-align: center; color: #999; grid-column: 1/-1;">ÃncÄƒ nu au fost Ã®ncÄƒrcate poze.</p>';
        return;
      }
      gallery.innerHTML = photos.map((photo) => `
        <div class="photo-item">
          <img src="${photo.src}" alt="PozÄƒ de la nuntÄƒ" loading="lazy">
          <div class="photo-info">
            <div class="guest-name">${photo.guestName}</div>
            <div class="upload-time">${photo.uploadTime}</div>
          </div>
        </div>
      `).join('');
    }

    // ===============================
    // GALERIA COMPLETÄ‚ DIN APPWRITE
    // ===============================
    async function loadGalleryFromAppwrite() {
      try {
        const result = await storage.listFiles(bucketId);

        photos = result.files.map(file => {
          const fileUrl =
            client.config.endpoint +
            '/storage/buckets/' + bucketId +
            '/files/' + file.$id +
            '/view?project=' + client.config.project;
          return {
            id: file.$id,
            src: fileUrl,
            guestName: file.name.split('-')[0] || "Invitat necunoscut",
            uploadTime: new Date(file.$createdAt).toLocaleString('ro-RO'),
            originalName: file.name
          };
        });

        // PopuleazÄƒ lista cu linkuri
        const list = document.getElementById('photoList');
        list.innerHTML = "";
        photos.forEach(photo => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="${photo.src}" target="_blank">${photo.guestName} â€“ ${photo.originalName}</a>`;
          list.appendChild(li);
        });

        displayPhotos();
      } catch (error) {
        console.error("Eroare la Ã®ncÄƒrcarea galeriei:", error);
        alert("Nu s-a putut Ã®ncÄƒrca galeria.");
      }
    }
  </script>
</body>
</html>
