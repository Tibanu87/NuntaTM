<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poze de la NuntƒÉ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #f5e6d3, #e8d5c4);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #8b7355, #a0926b);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .welcome-form {
            background: #f9f7f4;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e8d5c4;
        }

        .welcome-form h3 {
            color: #8b7355;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: bold;
        }

        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="file"]:focus {
            outline: none;
            border-color: #8b7355;
        }

        .btn {
            background: linear-gradient(45deg, #8b7355, #a0926b);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 115, 85, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .photo-upload {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed #8b7355;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .photo-item {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .photo-item:hover {
            transform: translateY(-5px);
        }

        .photo-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .photo-info {
            padding: 15px;
        }

        .photo-info .guest-name {
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 5px;
        }

        .photo-info .upload-time {
            font-size: 0.9em;
            color: #999;
        }

        .hidden {
            display: none;
        }

        .welcome-message {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-success {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            color: #2e7d2e;
        }

        .status-error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }

        .status-loading {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #1565c0;
        }

        /* Modal pentru vizualizarea pozelor */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            position: relative;
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 10px;
        }

        .modal img {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover {
            background: rgba(0,0,0,0.8);
        }

        .download-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #8b7355, #a0926b);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .download-btn:hover {
            background: linear-gradient(45deg, #a0926b, #8b7355);
        }

        .modal-info {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            text-align: center;
            z-index: 1001;
        }

        .modal-info .guest-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .modal-info .upload-time {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Camera Styles */
        .camera-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #2196f3;
        }

        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #cameraVideo {
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .camera-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .camera-btn {
            font-size: 18px;
            padding: 15px 30px;
            background: linear-gradient(45deg, #4caf50, #45a049);
        }

        .gallery-section.hidden {
            display: none;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b7355;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style special pentru separarea op»õiunilor */
        .upload-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-option {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            text-align: center;
        }

        .upload-option h4 {
            color: #8b7355;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .upload-option .description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }

            .upload-options {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üíï Vrem sƒÉ vedem nunta noastrƒÉ prin ochii tƒÉi! üíï</h2>
            <p>üéâ Maria »ôi Tiberiu - 6 Septembrie 2025 üéâ</p>
        </div>
        
        <div class="content">
            <!-- Status Messages -->
            <div id="statusMessage" class="status-message hidden"></div>

            <div id="welcomeForm" class="welcome-form">
                <h3>BunƒÉ! Te rugƒÉm sƒÉ ne spui cine e»ôti:</h3>
                <div class="form-group">
                    <label for="guestName">Numele tƒÉu, te rog:</label>
                    <input type="text" id="guestName" placeholder="ex: Ana »ôi Mihai Popescu">
                </div>
                <button class="btn" onclick="setGuestName()">ConfirmƒÉ</button>
            </div>

            <div id="mainApp" class="hidden">
                <div id="welcomeMessage" class="welcome-message">
                    <strong>Bun venit!</strong> Acum pute»õi adƒÉuga poze »ôi vedea pozele celorlal»õi invita»õi.
                </div>

                <div class="photo-upload">
                    <h3>üì∏ AdaugƒÉ o pozƒÉ nouƒÉ</h3>
                    
                    <!-- Op»õiuni separate pentru √ÆncƒÉrcare -->
                    <div class="upload-options">
                        <div class="upload-option">
                            <h4>üì± Alege din galerie</h4>
                            <div class="description">SelecteazƒÉ poze existente din telefon</div>
                            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                            <button class="btn" onclick="document.getElementById('photoInput').click()" style="background: linear-gradient(45deg, #2196f3, #1976d2);">üìÇ Alege Fi»ôiere</button>
                        </div>
                        
                        <div class="upload-option">
                            <h4>üì∑ FƒÉ poze noi</h4>
                            <div class="description">Folose»ôte camera pentru poze noi</div>
                            <button class="btn" onclick="openCamera()" id="cameraBtn" style="background: linear-gradient(45deg, #4caf50, #45a049);">üì∑ Deschide Camera</button>
                        </div>
                    </div>

                    <!-- Buton de √ÆncƒÉrcare »ôi alte controale -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn" onclick="uploadPhotos()" id="uploadBtn">üì§ √éncarcƒÉ Pozele</button>
                        <button class="btn" onclick="toggleGallery()" id="galleryToggleBtn" style="background: linear-gradient(45deg, #2196f3, #1976d2);">üñºÔ∏è Vezi Galerie</button>
                        <button class="btn" onclick="refreshGallery()" id="refreshBtn" style="background: linear-gradient(45deg, #ff9800, #f57c00);">üîÑ Re√ÆncarcƒÉ</button>
                    </div>

                    <!-- Afi»ôare fi»ôiere selectate -->
                    <div id="selectedFiles" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                        <strong>Fi»ôiere selectate:</strong>
                        <div id="fileList"></div>
                    </div>
                </div>

                <!-- Camera Section -->
                <div id="cameraSection" class="camera-section hidden">
                    <h3 style="color: #8b7355; margin-bottom: 20px;">üì∑ FƒÉ o pozƒÉ</h3>
                    <div class="camera-container">
                        <video id="cameraVideo" autoplay playsinline></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <div class="camera-controls">
                            <button class="btn camera-btn" onclick="capturePhoto()" id="captureBtn">üì∑ FƒÉ Poza</button>
                            <button class="btn" onclick="closeCamera()" style="background: linear-gradient(45deg, #f44336, #d32f2f);">‚ùå √énchide</button>
                        </div>
                    </div>
                </div>

                <div class="gallery-section" id="gallerySection">
                    <h3 style="color: #8b7355; margin-bottom: 20px;">üì∑ Galeria Foto</h3>
                    <div id="photoGallery" class="gallery">
                        <!-- Galeria va fi populatƒÉ dinamic -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pentru vizualizarea pozelor -->
    <div id="photoModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="" alt="PozƒÉ de la nuntƒÉ">
            <div id="modalInfo" class="modal-info">
                <div class="guest-name"></div>
                <div class="upload-time"></div>
            </div>
            <button class="download-btn" onclick="downloadPhoto()">
                üíæ SalveazƒÉ poza
            </button>
        </div>
    </div>

    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    
    <script>
        // ========== CONFIGURARE APPWRITE ==========
        const APPWRITE_ENDPOINT = 'https://fra.cloud.appwrite.io/v1';
        const APPWRITE_PROJECT_ID = '68b1d9c5002d64986cc4';
        const APPWRITE_DATABASE_ID = 'nunta-database';
        const APPWRITE_COLLECTION_ID = 'photos';
        const APPWRITE_BUCKET_ID = '68b1da9b002d5fd5fe09';

        // ========== VARIABILE GLOBALE ==========
        let currentGuest = '';
        let photos = [];
        let currentPhotoIndex = 0;
        let cameraStream = null;
        let galleryVisible = true;
        let isAuthenticated = false;
        let client, account, databases, storage;

        // ========== FUNC»öII PRINCIPALE ==========
        
        // Ini»õializare aplica»õie - NU se autentificƒÉ automat
        window.addEventListener('load', () => {
            console.log('Aplica»õia s-a √ÆncƒÉrcat. A»ôteptƒÉm numele utilizatorului.');
        });

        // Ini»õializarea Appwrite doar c√¢nd e necesar
        async function initializeAppwrite() {
            try {
                if (typeof Appwrite === 'undefined') {
                    throw new Error('SDK-ul Appwrite nu este disponibil');
                }

                const { Client, Account, Databases, Storage, ID } = Appwrite;
                
                client = new Client();
                client
                    .setEndpoint(APPWRITE_ENDPOINT)
                    .setProject(APPWRITE_PROJECT_ID);

                account = new Account(client);
                databases = new Databases(client);
                storage = new Storage(client);

                console.log('Appwrite ini»õializat cu succes');
                return true;
            } catch (error) {
                console.error('Eroare la ini»õializarea Appwrite:', error);
                showStatus('Eroare la ini»õializarea aplica»õiei', 'error');
                return false;
            }
        }

        // Autentificare anonimƒÉ - apelatƒÉ doar c√¢nd e necesarƒÉ
        async function authenticateUser() {
            if (!client) {
                const initialized = await initializeAppwrite();
                if (!initialized) return false;
            }

            try {
                showStatus('Se conecteazƒÉ la server...', 'loading');
                
                // √éncearcƒÉ sƒÉ ob»õii sesiunea curentƒÉ
                const user = await account.get();
                isAuthenticated = true;
                console.log('Utilizator deja autentificat:', user);
                hideStatus();
                return true;
            } catch (error) {
                console.log('Nu existƒÉ sesiune activƒÉ, se creeazƒÉ sesiune anonimƒÉ...');
                try {
                    // CreeazƒÉ sesiune anonimƒÉ
                    const session = await account.createAnonymousSession();
                    isAuthenticated = true;
                    console.log('Sesiune anonimƒÉ creatƒÉ cu succes:', session);
                    hideStatus();
                    return true;
                } catch (authError) {
                    console.error('Eroare la autentificare:', authError);
                    showStatus('Nu s-a putut stabili conexiunea cu serverul', 'error');
                    return false;
                }
            }
        }

        // Setarea numelui utilizatorului
        async function setGuestName() {
            const nameInput = document.getElementById('guestName');
            const name = nameInput.value.trim();
            
            if (name === '') {
                alert('VƒÉ rugƒÉm sƒÉ introduce»õi numele!');
                return;
            }
            
            currentGuest = name;
            
            // Ascunde formularul de bun venit »ôi aratƒÉ aplica»õia principalƒÉ
            document.getElementById('welcomeForm').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `<strong>Bun venit, ${currentGuest}!</strong> Acum pute»õi adƒÉuga poze »ôi vedea pozele celorlal»õilor invita»õi.`;
            
            // ACUM √ÆncercƒÉm sƒÉ ne autentificƒÉm »ôi sƒÉ √ÆncƒÉrcƒÉm pozele
            const authenticated = await authenticateUser();
            if (authenticated) {
                await loadPhotos();
            } else {
                showStatus('ProblemƒÉ la conectarea cu serverul. Unele func»õii ar putea sƒÉ nu meargƒÉ.', 'error');
            }
        }

        // Event listener pentru selectarea fi»ôierelor
        document.addEventListener('DOMContentLoaded', function() {
            const photoInput = document.getElementById('photoInput');
            if (photoInput) {
                photoInput.addEventListener('change', function(e) {
                    const files = e.target.files;
                    const selectedFilesDiv = document.getElementById('selectedFiles');
                    const fileListDiv = document.getElementById('fileList');
                    
                    if (files.length > 0) {
                        let fileNames = Array.from(files).map(file => file.name).join(', ');
                        fileListDiv.textContent = `${files.length} fi»ôier(e): ${fileNames}`;
                        selectedFilesDiv.style.display = 'block';
                    } else {
                        selectedFilesDiv.style.display = 'none';
                    }
                });
            }
        });

        // √éncƒÉrcare poze din fi»ôiere
        async function uploadPhotos() {
            const photoInput = document.getElementById('photoInput');
            const files = photoInput.files;
            
            if (files.length === 0) {
                alert('VƒÉ rugƒÉm sƒÉ selecta»õi cel pu»õin o pozƒÉ folosind butonul "Alege Fi»ôiere"!');
                return;
            }

            // VerificƒÉ autentificarea
            if (!isAuthenticated) {
                const authenticated = await authenticateUser();
                if (!authenticated) {
                    showStatus('Nu s-a putut stabili conexiunea cu serverul', 'error');
                    return;
                }
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Se √ÆncarcƒÉ...';
            
            let successCount = 0;
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    try {
                        await uploadSinglePhoto(file);
                        successCount++;
                    } catch (error) {
                        console.error('Eroare la √ÆncƒÉrcarea pozei:', error);
                        showStatus('Eroare la √ÆncƒÉrcarea unei poze: ' + error.message, 'error');
                    }
                }
            }
            
            photoInput.value = '';
            document.getElementById('selectedFiles').style.display = 'none';
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üì§ √éncarcƒÉ Pozele';
            
            if (successCount > 0) {
                showStatus(`${successCount} poze au fost √ÆncƒÉrcate cu succes!`, 'success');
                await loadPhotos();
            }
        }

        // √éncarcƒÉ o singurƒÉ pozƒÉ
        async function uploadSinglePhoto(file) {
            try {
                const { ID } = Appwrite;
                
                // Upload fi»ôier √Æn storage
                const fileUpload = await storage.createFile(
                    APPWRITE_BUCKET_ID,
                    ID.unique(),
                    file
                );

                // CreeazƒÉ √Ænregistrarea √Æn database
                const photoDoc = await databases.createDocument(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_COLLECTION_ID,
                    ID.unique(),
                    {
                        fileId: fileUpload.$id,
                        guestName: currentGuest,
                        fileName: file.name,
                        fileSize: file.size,
                        uploadTime: new Date().toISOString()
                    }
                );

                return photoDoc;
            } catch (error) {
                console.error('Upload error:', error);
                throw error;
            }
        }

        // √éncƒÉrcarea pozelor din database
        async function loadPhotos() {
            if (!isAuthenticated) {
                const authenticated = await authenticateUser();
                if (!authenticated) {
                    showStatus('Nu s-a putut √ÆncƒÉrca galeria', 'error');
                    return;
                }
            }
            
            showStatus('Se √ÆncarcƒÉ pozele...', 'loading');
            
            try {
                const response = await databases.listDocuments(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_COLLECTION_ID
                );

                photos = [];
                
                for (let doc of response.documents) {
                    try {
                        const fileUrl = storage.getFileView(APPWRITE_BUCKET_ID, doc.fileId);
                        
                        photos.push({
                            id: doc.$id,
                            src: fileUrl,
                            guestName: doc.guestName,
                            uploadTime: new Date(doc.uploadTime).toLocaleString('ro-RO'),
                            fileId: doc.fileId,
                            fileName: doc.fileName || 'poze-nunta.jpg'
                        });
                    } catch (fileError) {
                        console.error('Eroare la √ÆncƒÉrcarea fi»ôierului:', fileError);
                    }
                }
                
                // SorteazƒÉ pozele dupƒÉ data √ÆncƒÉrcƒÉrii (cele mai noi primul)
                photos.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
                
                displayPhotos();
                hideStatus();
                
            } catch (error) {
                console.error('Load photos error:', error);
                showStatus('Eroare la √ÆncƒÉrcarea pozelor', 'error');
            }
        }

        // Afi»ôarea pozelor √Æn galerie
        function displayPhotos() {
            const gallery = document.getElementById('photoGallery');
            
            if (photos.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #999; grid-column: 1/-1;">√éncƒÉ nu au fost √ÆncƒÉrcate poze. Fi»õi primul care adaugƒÉ o pozƒÉ!</p>';
                return;
            }
            
            gallery.innerHTML = photos.map((photo, index) => `
                <div class="photo-item" onclick="openModal(${index})">
                    <img src="${photo.src}" alt="PozƒÉ de la nuntƒÉ" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y0ZjRmNCIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiPkVyb2FyZSBpbmNhcmNhcmU8L3RleHQ+PC9zdmc+'">
                    <div class="photo-info">
                        <div class="guest-name">${photo.guestName}</div>
                        <div class="upload-time">${photo.uploadTime}</div>
                    </div>
                </div>
            `).join('');
        }

        // ========== FUNC»öII CAMERA ==========
        async function openCamera() {
            try {
                showStatus('Se acceseazƒÉ camera...', 'loading');
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;

                document.getElementById('cameraSection').classList.remove('hidden');
                document.getElementById('captureBtn').disabled = false;
                hideStatus();

                document.getElementById('cameraSection').scrollIntoView({ 
                    behavior: 'smooth' 
                });

            } catch (error) {
                console.error('Eroare la accesarea camerei:', error);
                showStatus('Nu s-a putut accesa camera. Verifica»õi permisiunile √Æn browser.', 'error');
            }
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraSection').classList.add('hidden');
        }

        async function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            
            if (!video.videoWidth || !video.videoHeight) {
                showStatus('Camera nu este √ÆncƒÉ gata. √éncerca»õi din nou √Æn c√¢teva secunde.', 'error');
                return;
            }

            // VerificƒÉ autentificarea √Ænainte de a face poza
            if (!isAuthenticated) {
                const authenticated = await authenticateUser();
                if (!authenticated) {
                    showStatus('Nu s-a putut stabili conexiunea cu serverul', 'error');
                    return;
                }
            }
            
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const captureBtn = document.getElementById('captureBtn');
            const originalText = captureBtn.textContent;
            captureBtn.textContent = '‚è≥ Se salveazƒÉ...';
            captureBtn.disabled = true;

            try {
                // Converte»ôte canvas √Æn blob
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/jpeg', 0.9);
                });
                
                // CreeazƒÉ file din blob
                const timestamp = Date.now();
                const file = new File([blob], `camera-${timestamp}.jpg`, { type: 'image/jpeg' });
                
                await uploadSinglePhoto(file);
                
                showStatus('Poza a fost salvatƒÉ cu succes!', 'success');
                await loadPhotos();
                
                if (!galleryVisible) {
                    toggleGallery();
                }
                
            } catch (error) {
                console.error('Eroare la salvarea pozei:', error);
                showStatus('Eroare la salvarea pozei: ' + error.message, 'error');
            } finally {
                captureBtn.textContent = originalText;
                captureBtn.disabled = false;
            }
        }

        // ========== FUNC»öII MODAL »òI GALERIE ==========
        function openModal(photoIndex) {
            currentPhotoIndex = photoIndex;
            const photo = photos[photoIndex];
            const modal = document.getElementById('photoModal');
            const modalImage = document.getElementById('modalImage');
            const modalInfo = document.getElementById('modalInfo');
            
            modalImage.src = photo.src;
            modalInfo.querySelector('.guest-name').textContent = photo.guestName;
            modalInfo.querySelector('.upload-time').textContent = photo.uploadTime;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('photoModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function downloadPhoto() {
            const photo = photos[currentPhotoIndex];
            try {
                const response = await fetch(photo.src);
                const blob = await response.blob();
                
                const link = document.createElement('a');
                link.download = `nunta-${photo.guestName.replace(/\s+/g, '-')}-${Date.now()}.jpg`;
                link.href = URL.createObjectURL(blob);
                link.click();
                
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Download error:', error);
                showStatus('Eroare la descƒÉrcarea pozei.', 'error');
            }
        }

        function toggleGallery() {
            const gallerySection = document.getElementById('gallerySection');
            const toggleBtn = document.getElementById('galleryToggleBtn');
            
            galleryVisible = !galleryVisible;
            
            if (galleryVisible) {
                gallerySection.classList.remove('hidden');
                toggleBtn.textContent = 'üôà Ascunde Galerie';
                toggleBtn.style.background = 'linear-gradient(45deg, #ff9800, #f57c00)';
            } else {
                gallerySection.classList.add('hidden');
                toggleBtn.textContent = 'üñºÔ∏è Vezi Galerie';
                toggleBtn.style.background = 'linear-gradient(45deg, #2196f3, #1976d2)';
            }
        }

        async function refreshGallery() {
            if (!isAuthenticated) {
                showStatus('Se conecteazƒÉ...', 'loading');
                const authenticated = await authenticateUser();
                if (!authenticated) {
                    showStatus('Nu s-a putut stabili conexiunea', 'error');
                    return;
                }
            }
            
            showStatus('Se re√ÆncarcƒÉ galeria...', 'loading');
            await loadPhotos();
        }

        // ========== FUNC»öII UTILITARE ==========
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => hideStatus(), 3000);
            }
        }

        function hideStatus() {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.classList.add('hidden');
        }

        // Event listeners
        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Permite introducerea numelui cu Enter
        document.addEventListener('DOMContentLoaded', function() {
            const guestNameInput = document.getElementById('guestName');
            if (guestNameInput) {
                guestNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        setGuestName();
                    }
                });
            }
        });

        // Gestionare erori globale
        window.addEventListener('error', function(e) {
            console.error('Eroare JavaScript:', e.error);
            showStatus('A apƒÉrut o eroare nea»ôteptatƒÉ', 'error');
        });

        // Gestionare erori pentru promisiuni negestionate
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise rejection neges»õionat:', e.reason);
            if (e.reason && e.reason.message && e.reason.message.includes('fetch')) {
                showStatus('ProblemƒÉ de conectivitate. Verifica»õi internetul.', 'error');
            }
        });
    </script>
</body>
</html>
